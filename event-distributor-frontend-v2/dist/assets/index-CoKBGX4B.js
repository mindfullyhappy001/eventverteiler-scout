import{createClient as C}from"https://esm.sh/@supabase/supabase-js@2";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const a=t=>document.querySelector(t),p=(t,n)=>{try{localStorage.setItem(t,typeof n=="string"?n:JSON.stringify(n))}catch{}},u=(t,n)=>{try{const e=localStorage.getItem(t);return e?e.startsWith("{")||e.startsWith("[")?JSON.parse(e):e:n}catch{return n}};localStorage.getItem("supabaseUrl")||p("supabaseUrl","https://owkkygszfljtkhjidmnv.supabase.co");localStorage.getItem("supabaseAnon")||p("supabaseAnon","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93a2t5Z3N6ZmxqdGtoamlkbW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MzIzMzYsImV4cCI6MjA3MjMwODMzNn0.9H6ifHfZi4QG4dAcsBm3P6f0DZDgKvTv5onL6ZTj-Fc");localStorage.getItem("appMode")||p("appMode","supabase");function w(){return{mode:u("appMode","supabase"),apiBase:u("apiBase","http://localhost:8080"),supabaseUrl:u("supabaseUrl",""),supabaseAnon:u("supabaseAnon","")}}function g(){const t=w();return!t.supabaseUrl||!t.supabaseAnon?null:C(t.supabaseUrl,t.supabaseAnon)}function S(){const t=location.hash.replace("#","")||"dashboard";for(const n of["platforms","dashboard","logs"]){const e=document.getElementById(n);e&&e.classList.toggle("hidden",n!==t);const i=document.getElementById("nav-"+n);i&&i.classList.toggle("active",n===t)}}let l=u("eventsData",[]),b="",h="createdAt";function _(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}function L(){const t=a("#img_list");t.innerHTML="";const n=(a("#f_images").value||"").split(",").map(e=>e.trim()).filter(Boolean);for(const e of n){const i=document.createElement("span");i.className="chip",i.textContent=e.split("/").pop(),t.appendChild(i)}}function f(){const t=a("#events-tbody");t.innerHTML="";let n=[...l];if(b){const e=b.toLowerCase();n=n.filter(i=>(i.title||"").toLowerCase().includes(e)||(i.description||"").toLowerCase().includes(e)||(i.category||"").toLowerCase().includes(e)||(i.organizer||"").toLowerCase().includes(e))}n.sort((e,i)=>h==="date"?(e.date||"").localeCompare(i.date||""):h==="title"?(e.title||"").localeCompare(i.title||""):(i.createdAt||0)-(e.createdAt||0));for(const e of n){const i=document.createElement("tr");i.innerHTML=`
            <td>${e.title||"—"}</td>
            <td>${e.date?new Date(e.date).toLocaleString():"—"}</td>
            <td>${e.category||"—"}</td>
            <td>${e.status||"—"}</td>
            <td style="text-align:right;">
              <button class="btn" data-act="edit" data-id="${e.id}">Bearbeiten</button>
              <button class="btn" data-act="copy" data-id="${e.id}">Kopieren</button>
              <button class="btn" data-act="pub" data-id="${e.id}">Publish</button>
              <button class="btn" data-act="del" data-id="${e.id}">Löschen</button>
            </td>
          `,t.appendChild(i)}}async function D(t){if(t.id||(t.id=_()),t.createdAt||(t.createdAt=Date.now()),w().mode==="supabase"&&g()){const i=g();try{const{error:s}=await i.from("Event").upsert([{...t,id:t.id}]);if(s)throw s}catch(s){console.warn("Supabase save failed, falling back to local",s)}}const e=l.findIndex(i=>i.id===t.id);e>=0?l[e]=t:l.unshift(t),p("eventsData",l),f()}function B(){return{id:a("#f_id").value||void 0,title:a("#f_title").value.trim()||void 0,description:a("#f_desc").value.trim()||void 0,date:a("#f_date").value?new Date(a("#f_date").value).toISOString():void 0,time:a("#f_time").value||void 0,location:a("#f_location").value?I(a("#f_location").value):void 0,category:a("#f_category").value||void 0,tags:a("#f_tags").value?a("#f_tags").value.split(",").map(t=>t.trim()).filter(Boolean):[],price:a("#f_price").value?Number(a("#f_price").value):void 0,isVirtual:a("#f_virtual").checked||!1,images:a("#f_images").value?a("#f_images").value.split(",").map(t=>t.trim()).filter(Boolean):[],organizer:a("#f_organizer").value||void 0,url:a("#f_url").value||void 0}}function y(t){a("#f_id").value=(t==null?void 0:t.id)||"",a("#f_title").value=(t==null?void 0:t.title)||"",a("#f_desc").value=(t==null?void 0:t.description)||"",a("#f_date").value=t!=null&&t.date?new Date(t.date).toISOString().slice(0,16):"",a("#f_time").value=(t==null?void 0:t.time)||"",a("#f_location").value=t!=null&&t.location?JSON.stringify(t.location):"",a("#f_category").value=(t==null?void 0:t.category)||"",a("#f_tags").value=((t==null?void 0:t.tags)||[]).join(","),a("#f_price").value=(t==null?void 0:t.price)??"",a("#f_virtual").checked=!!(t!=null&&t.isVirtual),a("#f_images").value=((t==null?void 0:t.images)||[]).join(","),L(),a("#f_organizer").value=(t==null?void 0:t.organizer)||"",a("#f_url").value=(t==null?void 0:t.url)||""}function I(t){try{return JSON.parse(t)}catch{return t}}function U(t){const n=t.target.closest("button");if(!n)return;const e=n.dataset.id,i=n.dataset.act,s=l.find(o=>o.id===e);if(i==="edit"&&(y(s),window.location.hash="#dashboard",document.getElementById("new-card").scrollIntoView({behavior:"smooth"})),i==="copy"){const o={...s,id:void 0,title:(s.title||"Event")+" (Copy)"};y(o),window.location.hash="#dashboard"}i==="del"&&(l=l.filter(o=>o.id!==e),p("eventsData",l),f()),i==="pub"&&j(s)}function j(t){const n=a("#pub");n.style.display="block",a("#pub_event").textContent=t.title||t.id,a("#pub_id").value=t.id}function E(){a("#pub").style.display="none"}async function M(){const t=a("#pub_id").value,n=a("#pub_platform").value,e=a("#pub_method").value,i=a("#pub_when").value,s=a("#pub_action").value,o=w(),d={eventId:t,platform:n,method:e,action:s,scheduledAt:i?new Date(i).toISOString():void 0};try{if(o.mode==="api"){const c=await fetch(o.apiBase+"/api/publish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!c.ok)throw new Error(await c.text())}else{const c=g();if(!c)throw new Error("Supabase URL/Key fehlt");const{error:m}=await c.from("PublishJob").insert([{eventId:t,platform:n,method:e,action:s,scheduledAt:i?new Date(i).toISOString():new Date().toISOString(),status:"scheduled"}]);if(m)throw m}alert("Publishing angelegt. Status erscheint nach Ausführung."),E()}catch(c){alert("Fehler: "+(c.message||c))}}function z(){const n=[["id","title","description","date","time","location","category","tags","price","isVirtual","images","organizer","url"].join(",")];for(const o of l){const d=[o.id,o.title||"",(o.description||"").replace(/\n/g," "),o.date||"",o.time||"",o.location?JSON.stringify(o.location):"",o.category||"",(o.tags||[]).join("|"),o.price??"",o.isVirtual??"",(o.images||[]).join("|"),o.organizer||"",o.url||""].map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",");n.push(d)}const e=new Blob([n.join(`
`)],{type:"text/csv"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download="events.csv",s.click(),URL.revokeObjectURL(i)}function N(t){const n=new FileReader;n.onload=()=>{var d;const e=n.result,[i,...s]=String(e).split(/\r?\n/).filter(Boolean),o=i.split(",").map(c=>c.replace(/^"|"$/g,""));for(const c of s){const m=((d=c.match(/"([^"]|"")*"(?=,|$)/g))==null?void 0:d.map(v=>v.slice(1,-1).replace(/""/g,'"')))||[],r={};o.forEach((v,A)=>r[v]=m[A]);const O={id:_(),title:r.title||"",description:r.description||"",date:r.date||"",time:r.time||"",location:r.location?I(r.location):void 0,category:r.category||"",tags:r.tags?String(r.tags).split("|").filter(Boolean):[],price:r.price?parseFloat(r.price):void 0,isVirtual:r.isVirtual==="true"||r.isVirtual===!0,images:r.images?String(r.images).split("|").filter(Boolean):[],organizer:r.organizer||"",url:r.url||"",createdAt:Date.now()};l.push(O)}p("eventsData",l),f()},n.readAsText(t)}async function k(t){const n=(a("#f_images").value||"").split(",").map(i=>i.trim()).filter(Boolean),e=g();if(e){try{await e.storage.createBucket("event-images",{public:!0})}catch{}for(const i of t){const s=`${Date.now()}-${Math.random().toString(36).slice(2)}-${i.name}`,{error:o}=await e.storage.from("event-images").upload(s,i,{upsert:!1});if(o&&o.message&&!/Duplicate/.test(o.message)){alert("Upload Fehler: "+o.message);continue}const{data:d}=e.storage.from("event-images").getPublicUrl(s);n.push(d.publicUrl)}}else for(const i of t){const s=await J(i);n.push(s)}a("#f_images").value=n.join(","),L()}function J(t){return new Promise((n,e)=>{const i=new FileReader;i.onload=()=>n(i.result),i.onerror=e,i.readAsDataURL(t)})}async function P(){try{const t=g();if(!t)return;const{data:n,error:e}=await t.from("Event").select("*").order("createdAt",{ascending:!1});if(e)throw e;Array.isArray(n)&&(l=n,p("eventsData",l),f())}catch(t){console.warn("Supabase fetch failed (Schema noch nicht importiert?)",t)}}window.addEventListener("DOMContentLoaded",()=>{a("#mode").value=u("appMode","supabase"),a("#apiBase").value=u("apiBase","http://localhost:8080"),a("#supabaseUrl").value=u("supabaseUrl",""),a("#supabaseAnon").value=u("supabaseAnon",""),a("#events-tbody").addEventListener("click",U),a("#btn-save").addEventListener("click",()=>D(B())),a("#btn-reset").addEventListener("click",()=>y({})),a("#q").addEventListener("input",t=>{b=t.target.value,f()}),a("#sort").addEventListener("change",t=>{h=t.target.value,f()}),a("#csvfile").addEventListener("change",t=>{var e;const n=(e=t.target.files)==null?void 0:e[0];n&&N(n),t.target.value=""}),a("#btn-export").addEventListener("click",z),a("#pub_close").addEventListener("click",E),a("#pub_run").addEventListener("click",M),a("#img_file").addEventListener("change",t=>{const n=t.target.files;n!=null&&n.length&&k(n),t.target.value=""}),window.addEventListener("hashchange",S),S(),P(),f()});
